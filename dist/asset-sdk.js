var e=require("zod"),t=require("arweave"),n=require("@bundlr-network/client"),r=require("warp-contracts"),a=require("uuid"),o=require("ramda"),i=require("fpjson-lang");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=/*#__PURE__*/u(t),c=/*#__PURE__*/u(n),p=/*#__PURE__*/u(i),d=e.z.object({arweave:e.z.instanceof(s.default),bundlr:e.z.instanceof(c.default),warp:e.z.instanceof(r.Warp),warpCacheURL:e.z.string().default("https://cache.permapages.app"),wallet:e.z.any(),contracts:e.z.object({stamp:e.z.string().default("FMRHYgSijiUNBrFy-XqyNNXenHsCV0ThR4lGAPO4chA"),bar:e.z.string().default("VFr3Bk-uM-motpNNkkFg4lNW1BMmSfzqsVO551Ho4hA"),vouchdao:e.z.string().default("_z0ch80z_daDUFqC9jHjfOL8nekJcok4ZRkE_UesYsk")}).default({stamp:"FMRHYgSijiUNBrFy-XqyNNXenHsCV0ThR4lGAPO4chA",bar:"VFr3Bk-uM-motpNNkkFg4lNW1BMmSfzqsVO551Ho4hA",vouchdao:"_z0ch80z_daDUFqC9jHjfOL8nekJcok4ZRkE_UesYsk"}),sources:e.z.object({asset:e.z.string().default("x0ojRwrcHBmZP20Y4SY0mgusMRx-IYTjg5W8c3UFoNs")}).default({asset:"x0ojRwrcHBmZP20Y4SY0mgusMRx-IYTjg5W8c3UFoNs"})}),l=e.z.object({id:e.z.string().optional(),title:e.z.string().min(1).max(180),description:e.z.string().max(300),type:e.z.string(),topics:e.z.array(e.z.string()),balances:e.z.record(e.z.string(),e.z.number()),contentType:e.z.string().default("text/html"),data:e.z.string().or(e.z.instanceof(Uint8Array)).optional(),forks:e.z.string().default(""),groupId:e.z.string().optional(),meta:e.z.string().optional()});function f(){return f=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},f.apply(this,arguments)}function h(e,t,n){if(!e.s){if(n instanceof g){if(!n.s)return void(n.o=h.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(h.bind(null,e,t),h.bind(null,e,2));e.s=t,e.v=n;const r=e.o;r&&r(e)}}var g=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,a=this.s;if(a){var o=1&a?t:n;if(o){try{h(r,1,o(this.v))}catch(e){h(r,2,e)}return r}return this}return this.o=function(e){try{var a=e.v;1&e.s?h(r,1,t?t(a):a):n?h(r,1,n(a)):h(r,2,a)}catch(e){h(r,2,e)}},r},e}();function m(e){return e instanceof g&&1&e.s}function v(e){function t(t){return e.gql({query:'query ($groupIds: [String!]!, $cursor: String) {\n      transactions(first: 100, after: $cursor, tags: [\n        { name: "Group-Id", values: $groupIds }\n       ]) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          cursor\n          node {\n            id \n            tags {\n              name\n              value\n            }\n          }\n        }\n      }\n    }',variables:{groupIds:[t]}}).then(o.map(o.compose(b,o.prop("node"))))}return{getAsset:function(t){return I(t).then(e.gql).then(z).then(function(t){return Promise.all([e.getData(t.source).catch(o.always("No meta data...")),e.getData(t.asset.id).catch(o.always("No data..."))]).then(function(e){var n=e[0],r=e[1];return f({},b(t.asset),{meta:n,data:r})})}).then(function(t){return e.stampCache(["compose",["length"],["filter",["propEq","asset",t.id]],["values"],["prop","stamps"]]).then(function(e){return o.assoc("stamps",e.result,t)})})},createAsset:function(t){return t.groupId||(t.groupId=e.randomUUID()),e.publish(function(e){var t=o.map(function(e){return{name:"Topic:"+e,value:e}},e.topics);return{target:{data:e.data,tags:[{name:"Content-Type",value:e.contentType},{name:"Title",value:e.title},{name:"Description",value:e.description},{name:"Type",value:e.type},{name:"Published",value:String(Date.now())},{name:"Page-Code",value:e.groupId},{name:"Group-Id",value:e.groupId},{name:"Forks",value:e.forks},{name:"Init-State",value:JSON.stringify({balances:e.balances,pairs:[],name:e.type+"-"+e.groupId,ticker:e.type.toUpperCase(),settings:[["isTradeable",!0]]})}].concat(t)},meta:{data:e.meta,tags:[{name:"Content-Type",value:"text/markdown"},{name:"App-Name",value:"AssetSDK"},{name:"Title",value:e.title},{name:"Description",value:e.description},{name:"Type",value:e.type+"-meta"}]}}}(t))},stampAsset:function(t){return e.stamp(t)},getItemsByGroupId:t,getGroupGraph:function(n){return function(t){return I(t).then(e.gql).then(o.compose(o.prop("node"),o.head)).then(b)}(n).then(o.prop("groupId")).then(t).then(y)}}}function y(e){function t(e,n){return e&&e.length>0?(e.forEach(function(e){e.children=e.id===n.forks?o.append({id:n.id,group:n.groupId,node:n,children:[]},e.children):t(e.children,n)}),e):[]}return o.compose(o.reduce(function(e,n){return""===n.forks?(e.id=n.id,e.group=n.groupId,e.node=n,e.children=[]):e.children=e.id===n.forks?o.append({id:n.id,group:n.groupId,node:n,children:[]},e.children):t(e.children,n),e},{}),o.sortBy(o.prop("published")),o.reject(o.propEq("forks",void 0)))(e)}function b(e){var t=o.compose(o.prop("value"),function(t){return o.find(o.propEq("name",t),e.tags)}),n=t("Published")?Number(t("Published")):Date.now(),r=o.join(", ",o.pluck("value",o.filter(function(e){return/^Topic:/.test(e.name)},e.tags)));return{id:e.id,type:t("Type"),title:t("Title"),description:t("Description"),meta:t("META"),groupId:t("Group-Id"),forks:t("Forks"),published:n,stamps:0,topics:r}}function z(e){return{source:e[0].node.tags.find(o.propEq("name","META")).value,asset:e[0].node}}function I(e){return Promise.resolve({query:"query ($ids: [ID!], $cursor: String) {\n      transactions(first: 1, after: $cursor, \n        ids: $ids) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          cursor\n          node {\n            id\n            tags {\n              name\n              value\n            }\n          }\n        }\n      }\n    }",variables:{ids:[e]}})}module.exports={init:function(e){var t=function(e){var t=function(t){try{var n,r=function(r){return n?r:e.bundlr.upload(t.data,{tags:t.tags})},a=function(){if("use_wallet"===e.wallet)return Promise.resolve(e.arweave.createTransaction({data:t.data})).then(function(e){t.tags.map(function(t){return e.addTag(t.name,t.value)});var r=arweaveWallet.dispatch(e);return n=1,r})}();return Promise.resolve(a&&a.then?a.then(r):r(a))}catch(e){return Promise.reject(e)}};return{randomUUID:function(){return a.v4()},publish:function(n){return t(n.meta).then(function(r){return n.target.tags=[].concat(n.target.tags,[{name:"META",value:r.id},{name:"App-Name",value:"SmartWeaveContract"},{name:"App-Version",value:"0.3.0"},{name:"Contract-Src",value:e.sources.asset}]),t(n.target)}).then(function(t){return function(t){try{return Promise.resolve(e.warp.register(t,"node2")).then(function(e){return{id:e.contractTxId}})}catch(e){return Promise.reject(e)}}(t.id)})},getData:function(t){return e.arweave.api.get(t).then(o.prop("data"))},gql:function(t){try{var n=!0,r=[],a="",i=function(e,t,n){for(var r;;){var a=e();if(m(a)&&(a=a.v),!a)return o;if(a.then){r=0;break}var o=n();if(o&&o.then){if(!m(o)){r=1;break}o=o.s}}var i=new g,u=h.bind(null,i,2);return(0===r?a.then(c):1===r?o.then(s):(void 0).then(function(){(a=e())?a.then?a.then(c).then(void 0,u):c(a):h(i,1,o)})).then(void 0,u),i;function s(t){o=t;do{if(!(a=e())||m(a)&&!a.v)return void h(i,1,o);if(a.then)return void a.then(c).then(void 0,u);m(o=n())&&(o=o.v)}while(!o||!o.then);o.then(s).then(void 0,u)}function c(e){e?(o=n())&&o.then?o.then(s).then(void 0,u):s(o):h(i,1,o)}}(function(){return!!n},0,function(){return Promise.resolve((i={query:t.query,variables:f({},t.variables,{cursor:a})},e.arweave.api.post("graphql",i).then(function(e){if(e.data.errors)throw new Error(JSON.stringify(e.data.errors,null,2));return e}).then(o.path(["data","data","transactions"])))).then(function(e){e.edges&&e.edges.length&&(r=r.concat(e.edges),a=e.edges[e.edges.length-1].cursor),n=e.pageInfo.hasNextPage});var i});return Promise.resolve(i&&i.then?i.then(function(){return r}):r)}catch(e){return Promise.reject(e)}},stampCache:function(t){return fetch(e.warpCacheURL+"/"+e.contracts.stamp,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t)}).then(function(n){return n.ok?n.json():e.warp.contract(e.contracts.stamp).connect(e.wallet).setEvaluationOptions({internalWrites:!0,allowBigInt:!0}).readState().then(function(e){return p.default([t,e.cachedValue.state])})})},stamp:function(e){}}}(e=d.parse(e));return{create:function(e){return e=l.parse(e),v(t).createAsset(e)},get:function(e){return v(t).getAsset(e)},stamp:function(e){return v(t).stampAsset(e)},list:function(e){return v(t).getItemsByGroupId(e)},graph:function(e){return v(t).getGroupGraph(e)}}}};
//# sourceMappingURL=asset-sdk.js.map
